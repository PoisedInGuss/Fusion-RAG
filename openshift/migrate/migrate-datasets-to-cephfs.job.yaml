# Incoming: storage-datasets PVC (RBD, RWO) --- {Filesystem}
# Processing: dataset copy --- {1 job: rsync-like directory copy}
# Outgoing: shared-datasets PVC (CephFS, RWX) --- {Filesystem}

apiVersion: batch/v1
kind: Job
metadata:
  name: migrate-datasets-to-cephfs
  namespace: 425krish
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: migrate
        image: python:3.11-slim
        command: ["/bin/bash", "-lc"]
        args:
        - |
          set -euo pipefail
          echo "[migrate-datasets] uid/gid: $(id)"
          python3 - <<'PY'
          import shutil
          from pathlib import Path

          SRC = Path("/mnt/src")
          DST = Path("/mnt/dst")
          SKIP = {"lost+found"}

          print(f"[migrate-datasets] copying {SRC} -> {DST}")
          if not SRC.exists():
              print("[migrate-datasets] WARNING: source missing, nothing to copy")
          else:
              DST.mkdir(parents=True, exist_ok=True)
              for entry in SRC.iterdir():
                  if entry.name in SKIP:
                      print(f"[migrate-datasets] skip {entry}")
                      continue
                  target = DST / entry.name
                  if entry.is_dir():
                      print(f"[migrate-datasets] dir {entry} -> {target}")
                      shutil.copytree(entry, target, symlinks=True)
                  else:
                      print(f"[migrate-datasets] file {entry} -> {target}")
                      shutil.copy2(entry, target)

          print("[migrate-datasets] copy complete")
          PY
          echo "[migrate-datasets] du summary"
          du -sh /mnt/src || true
          du -sh /mnt/dst || true
          echo "[migrate-datasets] DONE"
        volumeMounts:
        - name: src
          mountPath: /mnt/src
        - name: dst
          mountPath: /mnt/dst
      volumes:
      - name: src
        persistentVolumeClaim:
          claimName: storage-datasets
      - name: dst
        persistentVolumeClaim:
          claimName: shared-datasets

